
# name: studio-nuxt-build
# run-name: studio nuxt build

# on:
#   # Runs on pushes targeting the default branch
#   push:
#     branches:
#       - 'master'

#   # Allows you to run this workflow manually from the Actions tab
#   workflow_dispatch:

# # Add write workflow permissions
# permissions:
#   contents: write

# # Allow one concurrent deployment
# concurrency:
#   group: "pages"
#   cancel-in-progress: true

# jobs:
#   # Build job
#   build-and-deploy:
#     runs-on: ${{ matrix.os }}
#     defaults:
#       run:
#         working-directory: .

#     strategy:
#       matrix:
#         os: [ubuntu-latest]
#         node: [20]

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Identify package manager
#         id: pkgman
#         run: |
#           cache=`[ -f "./pnpm-lock.yaml" ] && echo "pnpm" || ([ -f "./package-lock.json" ] && echo "npm" || ([ -f "./yarn.lock" ] && echo "yarn" || echo ""))`
#           package_manager=`[ ! -z "$cache" ] && echo "$cache" || echo "pnpm"`
#           echo "cache=$cache" >> $GITHUB_OUTPUT
#           echo "package_manager=$package_manager" >> $GITHUB_OUTPUT

#       - uses: pnpm/action-setup@v4
#         if: ${{ steps.pkgman.outputs.package_manager == 'pnpm' }}
#         name: Install pnpm
#         id: pnpm-install

#       - uses: actions/setup-node@v4
#         with:
#           version: ${{ matrix.node }}
#           cache: ${{ steps.pkgman.outputs.cache }}

#       - name: Install dependencies
#         run: ${{ steps.pkgman.outputs.package_manager }} install

#       - name: Generate
#         run: npx nuxi build --preset github_pages
#         env:
#           NUXT_CONTENT_PREVIEW_API: https://api.nuxt.studio
          

#       # Deployment job
#       - name: Deploy üöÄ
#         uses: JamesIves/github-pages-deploy-action@v4
name: studio-nuxt-build
run-name: studio nuxt build

on:
  # Runs on pushes targeting the default branch
  push:
    branches:
      - 'master' # ou 'main', dependendo da sua branch padr√£o

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Add write workflow permissions
permissions:
  contents: write # Necess√°rio para JamesIves/github-pages-deploy-action fazer push

# Allow one concurrent deployment
concurrency:
  group: "pages" # Ou um nome de grupo espec√≠fico para este workflow, ex: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build job
  build-and-deploy:
    runs-on: ubuntu-latest # Simplificado, j√° que a matrix s√≥ tinha uma op√ß√£o de OS
    defaults:
      run:
        working-directory: . # Define o diret√≥rio de trabalho para todos os comandos run

    # A matrix n√£o √© estritamente necess√°ria se voc√™ s√≥ tem uma combina√ß√£o de OS/Node,
    # mas pode ser mantida se voc√™ planeja testar com m√∫ltiplas vers√µes no futuro.
    # strategy:
    #   matrix:
    #     node: [20] # Ou uma vers√£o LTS como '18.x', '20.x'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Identify package manager and cache type
        id: pkgman
        run: |
          PACKAGE_MANAGER=""
          CACHE_TYPE=""

          if [ -f "./pnpm-lock.yaml" ]; then
            PACKAGE_MANAGER="pnpm"
            CACHE_TYPE="pnpm"
            echo "Using pnpm"
          elif [ -f "./yarn.lock" ]; then
            PACKAGE_MANAGER="yarn"
            CACHE_TYPE="yarn"
            echo "Using yarn"
          elif [ -f "./package-lock.json" ]; then
            PACKAGE_MANAGER="npm"
            CACHE_TYPE="npm"
            echo "Using npm"
          else
            # Default para pnpm se nenhum arquivo de lock for encontrado, ou voc√™ pode optar por falhar o workflow
            PACKAGE_MANAGER="pnpm"
            CACHE_TYPE="pnpm"
            echo "No lockfile found. Defaulting to pnpm."
          fi
          echo "package_manager=$PACKAGE_MANAGER" >> $GITHUB_OUTPUT
          echo "cache=$CACHE_TYPE" >> $GITHUB_OUTPUT

      # Configura pnpm se for o gerenciador de pacotes detectado
      # A vers√£o do pnpm ser√° lida do campo 'packageManager' no package.json
      - name: Setup pnpm
        if: steps.pkgman.outputs.package_manager == 'pnpm'
        uses: pnpm/action-setup@v4
        # A 'version' foi removida para usar a especificada no package.json (ex: pnpm@10.11.0)

      # Configura Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # Use a vers√£o do Node.js do seu projeto, ex: '20.x'
          cache: ${{ steps.pkgman.outputs.cache }} # Configura o cache para o gerenciador de pacotes detectado
          cache-dependency-path: '**/pnpm-lock.yaml' # Adicionado para maior precis√£o do cache com pnpm

      # PASSO ADICIONADO: Instala ferramentas de build necess√°rias para m√≥dulos nativos
      - name: Install build tools (Linux)
        if: runner.os == 'Linux' # Garante que este passo s√≥ roda em runners Linux
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libsqlite3-dev build-essential python3
        # Para outros OS, voc√™ precisaria de comandos diferentes (ex: brew install sqlite para macOS)

      # Instala depend√™ncias
      - name: Install dependencies
        run: |
          if [ "${{ steps.pkgman.outputs.package_manager }}" = "pnpm" ]; then
            ${{ steps.pkgman.outputs.package_manager }} install --frozen-lockfile
          elif [ "${{ steps.pkgman.outputs.package_manager }}" = "yarn" ]; then
            ${{ steps.pkgman.outputs.package_manager }} install --frozen-lockfile
          elif [ "${{ steps.pkgman.outputs.package_manager }}" = "npm" ]; then
            ${{ steps.pkgman.outputs.package_manager }} ci
          else
            echo "Unsupported package manager: ${{ steps.pkgman.outputs.package_manager }}"
            exit 1
          fi
        # A linha original era: ${{ steps.pkgman.outputs.package_manager }} install
        # Usar --frozen-lockfile (pnpm, yarn) ou ci (npm) √© recomendado para CI.

      # Gera o site est√°tico
      - name: Generate static site
        # √â recomend√°vel usar o gerenciador de pacotes para executar scripts locais
        run: ${{ steps.pkgman.outputs.package_manager }} exec nuxi build --preset github_pages
        # Alternativamente, se nuxi estiver globalmente dispon√≠vel ou via npx:
        # run: npx nuxi build --preset github_pages
        env:
          NUXT_CONTENT_PREVIEW_API: https://api.nuxt.studio
          # NODE_ENV: production # nuxi build geralmente define isso, mas pode ser expl√≠cito se necess√°rio

      # Faz o deploy para o GitHub Pages
      - name: Deploy to GitHub Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ./.output/public # A pasta que o Nuxt gera para o github_pages
          # branch: gh-pages # Opcional: a branch para a qual fazer o deploy (padr√£o: gh-pages)
          # clean: true # Opcional: remove arquivos existentes da branch de deploy antes
          # token: ${{ secrets.GITHUB_TOKEN }} # Opcional: padr√£o √© GITHUB_TOKEN

#         with:
#           folder: ./.output/public
